# Kubeflow Pipeline Builder

Visual DAG エディタと Python コード補完機能を備えた Kubeflow Pipelines パイプライン構築ツール

## 概要

このプロジェクトは、Kubeflow Pipelines のパイプラインを視覚的に構築編集できるWebアプリケーションです。

**主な機能:**
-  リアクティブな DAG エディタ（ReactFlow）
-  ノード単位での Python コード編集
-  パラメータ自動管理
-  VSCode 風の Python コード補完
  - numpy, pandas, pathlib などの標準ライブラリ
  - KFP 2.0 APIの補完
  - 関数の引数情報付き
-  自動 KFP コード生成
-  Docker マルチコンテナ構成（フロント + LSP サーバー）

## クイックスタート

### 前提条件

**Docker & Docker Compose** が必須です。以下のバージョン以上推奨：

| 環境 | インストール方法 | バージョン |
|---|---|---|
| **Windows / macOS** | [Docker Desktop](https://www.docker.com/products/docker-desktop) | 20.10+ |
| **Linux** | [Docker Engine](https://docs.docker.com/engine/install/) | 20.10+ |

ポート確認（既に使用されていないことを確認）：
- `3000` / `3001` - フロントエンド（本番 / 開発）
- `5000` - KFP Compiler API
- `8000` - LSP サーバー

### 起動

```bash
# リポジトリをクローン
git clone https://github.com/hiro134103/kubeflow-pipeline-builder.git
cd kubeflow-pipeline-builder

# Docker コンテナをビルド & 起動
docker-compose up --build
```

**すべてのプラットフォームで同一のコマンドで動作します。** ✅

### アクセス

- **フロントエンド**: http://localhost:3000 (本番) / http://localhost:3001 (開発)
- **LSP サーバー**: http://localhost:8000/health
- **KFP Compiler**: http://localhost:5000/health

## クイックチュートリアル

**5分でパイプライン コード生成まで**

### 1. パイプライン パラメータ設定

左パネルの「+ Add Parameter」：
- キー: `input_path`
- 型: `str`
- デフォルト値: `s3://data/input.csv`

### 2. ノード追加

左パネルの「Blank Component」をクリック → キャンバスに配置  
（2個のノードを追加）

### 3. ノード編集

ノード → 右パネルで設定：
- **関数名**: `load_data` → `train_model`
- **引数**: 各ノードで `+ Add Argument`
  - `load_data`: パイプラインパラメータ `input_path` を選択（型: str）
  - `train_model`: `load_data` の出力を選択（型: Dataset）
- **戻り値**: `Output[Dataset]`

### 3.5. Python コード編集（Monaco Editor）

ノードヘッダーのコードアイコン（</> ボタン）をクリック → Monaco Editor を開く

**コード補完機能**:
- `np.` と入力 → numpy メソッドが補完
- `pd.` と入力 → pandas メソッドが補完
- `@component` 入力 → KFP デコレータ補完
- `Ctrl+Space` で手動補完トリガー

```python
# load_data の例
def load_data(path: str) -> Dataset:
    import pandas as pd
    df = pd.read_csv(path)  # pd. で補完
    return df

# train_model の例  
def train_model(data: str) -> str:
    # 訓練ロジック
    return "model.pkl"
```

エディタ右下の「Save」で保存

### 4. ノード接続

`load_data` の出力 → `train_model` の入力にドラッグして接続

### 5. 自動コード生成

右下の「GENERATE PYTHON」をクリック

生成コード（例）:
```python
@component()
def load_data(path: str) -> Dataset:
    import pandas as pd
    df = pd.read_csv(path)
    return df

@component()
def train_model(data: str) -> str:
    return "model.pkl"

@pipeline(name='MyPipeline')
def MyPipeline(input_path: str = 's3://data/input.csv'):
    step0 = load_data(input_path)
    step1 = train_model(step0.output)
```

**ダウンロード**: 「DOWNLOAD PYTHON」で `.py` ファイル保存 ✅

---

## プロジェクト構成

```
kubeflow-pipeline-builder/
 docker-compose.yml              # マルチコンテナ定義
 .dockerignore
 .gitignore
 README.md

 frontend/                       # React アプリケーション
    Dockerfile                  # 本番用 (2段階ビルド)
    nginx.conf                  # Nginx ルーティング設定
    package.json
    public/
    src/
       App.js                  # メインコンポーネント
       components/             # UI コンポーネント
       hooks/                  # React Hooks
       utils/                  # ユーティリティ
    build/                      # ビルド出力

 backend/                        # Python バックエンド
     Dockerfile                  # LSP サーバー
     Dockerfile.compiler         # KFP Compiler
     requirements.txt
     lsp_wrapper.py              # Flask LSP サーバー
     app.py                      # Flask Compiler API
```

## アーキテクチャ

**フロントエンド**: React + ReactFlow + Monaco Editor で DAG ビジュアルエディタ

**バックエンド**: 
- LSP サーバー (Jedi) - Python コード補完
- KFP Compiler - DAG を YAML にコンパイル
- Nginx リバースプロキシ

## 使用イメージ

### DAG エディタ & パイプライン構築

パイプラインを視覚的に構築できます。以下のスクリーンショットは実際の UI です：

![Pipeline Builder UI](https://github.com/hiro134103/kubeflow-pipeline-builder/raw/main/.github/images/pipeline-builder.png)

**主な機能**：
- **左パネル**: パイプラインパラメータ（init_path, image_pattern など）とコンポーネント/ノード一覧
- **中央**: ReactFlow による DAG キャンバス
  - ノードをドラッグ&ドロップで配置
  - ノード間をドラッグして接続
  - クリックでノードを選択・編集
- **右パネル**: 選択ノードの詳細編集
  - 関数名、引数、出力型、説明を設定
  - Monaco Editor による Python コード編集（LSP 補完対応）

### コード生成結果

ビジュアルエディタで構築したパイプラインから、KFP 2.0 互換の Python コードが自動生成されます：

![Generated Pipeline Code](https://github.com/hiro134103/kubeflow-pipeline-builder/raw/main/.github/images/generated-code.png)

**生成される内容例**：
```python
# Pipeline: MyPipeline
# Generated by Pipeline Builder
# Params: [("id":"1","key":"init_path",...), ("id":"2","key":"image_pattern",...), ...]

from kfp.dsl import pipeline, component

@component()
def evaluation(inference_image_path: str) -> Any:
    """Evaluates the inference results."""
    print(f"Evaluating results from: {inference_image_path}")
    # Logic for calculating metrics

@component()
def inference_image(pattern: str) -> str:
    """Performs inference using the trained model on specified images."""
    print(f"Performing inference on matching '{pattern}' using model: {model_uri}")
    with open(inference_result_path, 'w') as f:
        f.write("Inference Results URI")
    return "Inference Results URI"

@component()
def visualize(inference_result_path: str) -> Dataset:
    """Visualizes the inference results."""
    print(f"Visualizing inference from: {inference_result_path}")
    # Logic for generating plots/dashboards

@component()
def model_training(model_path: str) -> Model:
    """Trains a model and saves it to a specified path."""
    print(f"Training model using data from: {data_path}")
    # In a real component, the model would be saved to model_path
    with open(model_path, 'w') as f:
        f.write("Model v1 URI")
    return "Model v1 URI"

@pipeline(name='MyPipeline')
def MyPipeline(init_path: str = 's3://directory', image_pattern: str = '*.png', warning_up_rate: float = 8.0):
    step0 = evaluation(step1.output)
    step1 = inference_image(image_pattern)
    step2 = visualize(step1.output)
    step3 = model_training(init_path)
    step1.after(step3)
```

**ダウンロード機能**: 「DOWNLOAD PYTHON」ボタンでコードを .py ファイルとして保存可能

## 開発ガイド

```bash
# Docker で起動
docker-compose up --build

# ローカル開発
cd frontend && npm install && npm start  # :3000
cd backend && pip install -r requirements.txt && python lsp_wrapper.py  # :8000
```

## 主な機能

### 1. DAG ビジュアルエディタ
- ノード追加・削除、エッジ接続、ドラッグ&ドロップ

### 2. Python コード編集（Monaco + LSP）
- リアルタイム補完（numpy, pandas, KFP API）
- シンタックスハイライト

### 3. パラメータ管理
- パイプラインパラメータ（全ノード共有）
- ノード引数（型選択：str, int, float, bool, Input[Dataset]）
- 出力パラメータ（Output[Dataset] 対応）

### 4. コード生成
- KFP DSL 2.0 形式で Python コード自動生成
- トポロジカルソートで依存関係を正しく処理
- ダウンロード対応

### 5. KFP Compiler（実験的）
- 生成コードを YAML にコンパイル
- Kubeflow へのデプロイ準備

## トラブルシューティング

**ポート競合**:
```bash
docker-compose down
docker system prune -f --volumes
docker-compose up
```

**LSP サーバーエラー**:
```bash
curl http://localhost:8000/health
docker-compose logs language-server
docker-compose restart language-server
```

**Compiler エラー**:
```bash
curl http://localhost:5000/health
docker-compose logs kfp-compiler
docker-compose restart kfp-compiler
```

## パフォーマンス

| メトリクス | 値 |
|---|---|
| フロント ビルドサイズ | ~204KB (minified) |
| Nginx レスポンス | <1ms |
| LSP 補完レスポンス | 10-50ms (Jedi 解析) |
| LSP サーバー メモリ | ~200MB (Python + Jedi) |
| Docker イメージサイズ | frontend: 52MB, backend: 350MB |

## バージョン情報

- **Node.js**: 20-alpine
- **React**: 19.2.0
- **Python**: 3.11-slim
- **Flask**: 3.0.0
- **Flask-CORS**: 4.0.0
- **Jedi**: 0.18.1 (KFP 補完互換性のため <0.19.0)
- **KFP**: 2.0.0
- **scikit-learn**: 1.3.2
- **numpy**: 1.24.3
- **pandas**: 2.0.3

## ライセンス

MIT

## 参考リンク

- [Kubeflow Pipelines 公式](https://www.kubeflow.org/docs/components/pipelines/)
- [ReactFlow ドキュメント](https://reactflow.dev/)
- [Jedi - Python Autocompletion](https://jedi.readthedocs.io/)
- [Monaco Editor](https://microsoft.github.io/monaco-editor/)
- [Flask](https://flask.palletsprojects.com/)
- [Nginx](https://nginx.org/)
